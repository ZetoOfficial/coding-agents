# Multi-stage Dockerfile for production deployment

FROM python:3.11.8-slim AS base

# Set working directory
WORKDIR /app

# Install system dependencies
RUN apt-get update && apt-get install -y \
    git \
    ca-certificates \
    curl \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

# Configure git
RUN git config --global user.name "github-actions[bot]" && \
    git config --global user.email "github-actions[bot]@users.noreply.github.com"

# Install uv package manager via pip (more reliable for Docker)
RUN pip install --no-cache-dir uv

# ========== Builder Stage ==========
FROM base AS builder

# Copy dependency files
COPY pyproject.toml uv.lock README.md ./

# Copy source code (needed for editable install)
COPY src/ ./src/

# Install dependencies with all groups
# --no-dev is deprecated, use --all-extras to include all optional dependencies
RUN uv sync --frozen --all-extras

# ========== Web Server Stage ==========
FROM base AS web

# Copy virtual environment and source from builder
COPY --from=builder /app/.venv /app/.venv
COPY --from=builder /app/src /app/src
COPY --from=builder /app/pyproject.toml /app/pyproject.toml

# Set Python path
ENV PATH="/app/.venv/bin:$PATH"
ENV PYTHONPATH="/app:$PYTHONPATH"

# Expose port
EXPOSE 8000

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=40s --retries=3 \
    CMD curl -f http://localhost:8000/health || exit 1

# Run uvicorn directly from .venv
CMD ["/app/.venv/bin/uvicorn", "src.webhook_server.app:app", "--host", "0.0.0.0", "--port", "8000", "--workers", "2"]

# ========== Worker Stage ==========
FROM base AS worker

# Copy virtual environment and source from builder
COPY --from=builder /app/.venv /app/.venv
COPY --from=builder /app/src /app/src
COPY --from=builder /app/pyproject.toml /app/pyproject.toml

# Set Python path
ENV PATH="/app/.venv/bin:$PATH"
ENV PYTHONPATH="/app:$PYTHONPATH"

# Create temp directory for repositories
RUN mkdir -p /tmp/repos

# Health check for worker (check RQ connection)
HEALTHCHECK --interval=60s --timeout=10s --start-period=30s --retries=3 \
    CMD python -c "from redis import Redis; import os; Redis.from_url(os.getenv('REDIS_URL')).ping()" || exit 1

# Run RQ worker (using shell form for env var interpolation)
CMD ["/bin/sh", "-c", "echo 'REDIS_URL from env: '${REDIS_URL} && echo 'HOSTNAME: '${HOSTNAME} && /app/.venv/bin/rq worker agent-tasks --url ${REDIS_URL} --name ${HOSTNAME} --with-scheduler"]